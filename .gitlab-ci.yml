stages:
  - build    # Single build stage for both backend and frontend
  - test     # Test stage
  - deploy   # Deploy stage

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Build both backend and frontend in sequence
build-application:
  stage: build
  tags:
    - local
  before_script:
    - docker info
  script:
    - echo "ğŸš€ Starting Complete Application Build..."
    - echo ""
    - echo "ğŸ”§ Step 1 - Building Backend Docker Image..."
    - cd backend
    - docker build -t scriptify-backend:latest .
    - docker tag scriptify-backend:latest ayushchoudhary6/scriptify-backend:latest
    - echo "âœ… Backend build completed!"
    - echo ""
    - echo "ğŸ¨ Step 2 - Building Frontend Docker Image..."
    - cd ../frontend
    - docker build -t scriptify-frontend:latest .
    - docker tag scriptify-frontend:latest ayushchoudhary6/scriptify-frontend:latest
    - echo "âœ… Frontend build completed!"
    - echo ""
    - echo "ğŸ“¤ Step 3 - Loading Images into Kind Cluster..."
    - kind load docker-image ayushchoudhary6/scriptify-backend:latest --name my-cluster
    - kind load docker-image ayushchoudhary6/scriptify-frontend:latest --name my-cluster
    - echo "âœ… Images loaded into Kubernetes cluster!"
    - echo ""
    - echo "ğŸ‰ Complete Application Build Finished Successfully!"
  only:
    - main

# Test stage (runs after build completes)
test-application:
  stage: test
  tags:
    - local
  script:
    - echo "ğŸ§ª Running Application Tests..."
    - echo "Verifying Backend image - ayushchoudhary6/scriptify-backend:latest"
    - docker images | grep scriptify-backend
    - echo "Verifying Frontend image - ayushchoudhary6/scriptify-frontend:latest"  
    - docker images | grep scriptify-frontend
    - echo "Verifying images are loaded in kind cluster..."
    - kubectl get pods --all-namespaces | grep -E "(backend|frontend)" || echo "No pods running yet (expected at this stage)"
    - echo "âœ… All tests passed!"
  only:
    - main
  needs:
    - build-application

#Deploy stage (automatic deployment to Kubernetes)
deploy-application:
  stage: deploy
  tags:
    - local
  before_script:
    - kubectl cluster-info || (echo "âŒ Kubernetes cluster not accessible" && exit 1)
    - kubectl get nodes
  script:
    - echo "ğŸš€ Deploying Application to Kubernetes..."
    - echo "ğŸ§¹ Cleaning up existing deployments..."
    - kubectl delete -f k8s/ --ignore-not-found=true
    - echo "â³ Waiting for cleanup to complete..."
    - sleep 10
    - echo "ğŸ”§ Applying Backend deployment and service..."
    - kubectl apply -f k8s/backend-deployment.yml
    - kubectl apply -f k8s/backend-service.yml
    - echo "ğŸ¨ Applying Frontend deployment and service..."
    - kubectl apply -f k8s/frontend-deployment.yml
    - kubectl apply -f k8s/frontend-service.yml
    - echo "ğŸ” Applying Secrets configuration..."
    - kubectl apply -f k8s/secrets.yml || echo "âš ï¸  Secrets not applied (may need manual configuration)"
    - echo "ğŸŒ Applying Ingress configuration..."
    - kubectl apply -f k8s/ingress.yml || echo "âš ï¸  Ingress not applied (may not be needed for local setup)"
    - echo "ğŸ“ˆ Applying HPA (Horizontal Pod Autoscaler)..."
    - kubectl apply -f k8s/hpa.yml || echo "âš ï¸  HPA not applied (metrics server may be required)"
    - echo "â³ Waiting for deployments to be ready..."
    - kubectl wait --for=condition=available --timeout=120s deployment/backend-deployment
    - kubectl wait --for=condition=available --timeout=120s deployment/frontend-deployment
    - echo "ğŸ”Œ Setting up persistent port forwarding..."
    - pkill -f "kubectl port-forward" || echo "No existing port-forward processes to kill"
    - sleep 2
    - echo "Starting background port forwarding processes..."
    - nohup kubectl port-forward service/frontend-service 3000:80 </dev/null >/dev/null 2>&1 & echo $! > /tmp/frontend-pf.pid
    - nohup kubectl port-forward service/backend-service 8000:8000 </dev/null >/dev/null 2>&1 & echo $! > /tmp/backend-pf.pid
    - sleep 5
    - echo "Port forwarding processes started with PIDs:"
    - cat /tmp/frontend-pf.pid 2>/dev/null || echo "Frontend PID not found"
    - cat /tmp/backend-pf.pid 2>/dev/null || echo "Backend PID not found"
    - echo "ğŸ§ª Verifying service accessibility..."
    - sleep 3
    - curl -f http://localhost:8000/ || echo "âš ï¸  Backend not accessible immediately"
    - curl -f -I http://localhost:3000 || echo "âš ï¸  Frontend not accessible immediately"
    - echo "âœ… Deployment completed successfully!"
    - echo ""
    - echo "ğŸ“Š Deployment Status:"
    - kubectl get deployments
    - kubectl get services
    - kubectl get pods
    - echo ""
    - echo "ğŸ“± Application is now live and accessible:"
    - echo "ğŸŒ Frontend - http://localhost:3000"
    - echo "ğŸ”§ Backend API - http://localhost:8000"
    - echo "ğŸ“– API Documentation - http://localhost:8000/docs"
    - echo "ğŸ¥ YouTube Summarizer is ready to use!"
    - echo ""
    - echo "âš¡ Application will remain accessible until the runner process stops"
  only:
    - main
  needs:
    - test-application
