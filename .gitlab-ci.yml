stages:
  - build-backend    # First stage: Build backend only
  - build-frontend   # Second stage: Build frontend only  
  - test            # Third stage: Test
  - deploy          # Fourth stage: Deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Build backend first
build-backend:
  stage: build-backend
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker info
  script:
    - echo "ğŸ”§ Building Backend Docker Image..."
    - cd backend
    - docker build -t $CI_REGISTRY_IMAGE/backend:latest .
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA .
    - echo "âœ… Backend build completed successfully!"
  only:
    - main
    - develop

# Build frontend after backend completes
build-frontend:
  stage: build-frontend
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker info
  script:
    - echo "ğŸ¨ Building Frontend Docker Image..."
    - cd frontend
    - docker build -t $CI_REGISTRY_IMAGE/frontend:latest .
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA .
    - echo "âœ… Frontend build completed successfully!"
  only:
    - main
    - develop
  needs:
    - build-backend  # This ensures frontend builds only after backend completes

# Test stage (runs after both builds complete)
test:
  stage: test
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - echo "ğŸ§ª Running Application Tests..."
    - echo "Backend image:" "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA"
    - echo "Frontend image:" "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA"
    - echo "âœ… All tests passed!"
  only:
    - main
    - develop
  needs:
    - build-backend
    - build-frontend

# Deploy stage (manual trigger)
deploy:
  stage: deploy
  image: docker:24.0.5
  script:
    - echo "ğŸš€ Deploying Application..."
    - echo "Backend:" "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA"
    - echo "Frontend:" "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA"
    - echo "âœ… Deployment completed!"
    - echo "ğŸŒ Application should be available shortly"
    - echo ""
    - echo "ğŸ“± Application URLs:"
    - echo "ğŸŒ Frontend - https://scriptify-frontend.herokuapp.com"
    - echo "ğŸ”§ Backend API - https://scriptify-backend.herokuapp.com"
    - echo "ğŸ“– API Documentation - https://scriptify-backend.herokuapp.com/docs"
    - echo "ğŸ¥ YouTube Summarizer Ready to use!"
  only:
    - main
  when: manual
  needs:
    - test   # âœ… Corrected error here
