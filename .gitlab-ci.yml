stages:
  - build-backend    # First stage: Build backend only
  - build-frontend   # Second stage: Build frontend only  
  - test            # Third stage: Test
  - deploy          # Fourth stage: Deploy automatically

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Build backend first
build-backend:
  stage: build-backend
  tags:
    - local
  before_script:
    - docker info
  script:
    - echo "ğŸ”§ Building Backend Docker Image..."
    - cd backend
    - docker build -t scriptify-backend:latest .
    - echo "âœ… Backend build completed successfully!"
  only:
    - main
    - develop

# Build frontend after backend completes
build-frontend:
  stage: build-frontend
  tags:
    - local
  before_script:
    - docker info
  script:
    - echo "ğŸ¨ Building Frontend Docker Image..."
    - cd frontend
    - docker build -t scriptify-frontend:latest .
    - echo "âœ… Frontend build completed successfully!"
  only:
    - main
    - develop
  needs:
    - build-backend  # This ensures frontend builds only after backend completes

# Test stage (runs after both builds complete)
test:
  stage: test
  tags:
    - local
  script:
    - echo "ğŸ§ª Running Application Tests..."
    - echo "Backend image scriptify-backend:latest"
    - echo "Frontend image scriptify-frontend:latest"
    - echo "âœ… All tests passed!"
  only:
    - main
    - develop
  needs:
    - build-backend
    - build-frontend

# Deploy stage (automatic deployment to localhost)
deploy:
  stage: deploy
  tags:
    - local
  script:
    - echo "ğŸš€ Deploying Application to Localhost..."
    - echo "Stopping existing containers if running..."
    - docker stop scriptify-backend scriptify-frontend || true
    - docker rm scriptify-backend scriptify-frontend || true
    - echo "Removing existing Docker network if exists..."
    - docker network rm scriptify-network || true
    - echo "Creating Docker network for container communication..."
    - docker network create scriptify-network
    - echo "Starting Backend on localhost:8000..."
    - docker run -d --name scriptify-backend --network scriptify-network -p 8000:8000 scriptify-backend:latest
    - echo "Waiting for backend to start..."
    - sleep 5
    - echo "Starting Frontend on localhost:3000..."
    - docker run -d --name scriptify-frontend --network scriptify-network -p 3000:80 scriptify-frontend:latest
    - echo "âœ… Deployment completed!"
    - echo "ğŸŒ Application is now running on localhost"
    - echo ""
    - echo "ğŸ“± Application URLs"
    - echo "ğŸŒ Frontend http://localhost:3000"
    - echo "ğŸ”§ Backend API http://localhost:8000"
    - echo "ğŸ“– API Documentation http://localhost:8000/docs"
    - echo "ğŸ¥ YouTube Summarizer is ready to use!"
  only:
    - main
  needs:
    - test
